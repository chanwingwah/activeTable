<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scale=none"> -->
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>动态表格设计</title>
    <link rel="stylesheet" href="jquery-easyui-1.8.5/themes/default/easyui.css">
    <link rel="stylesheet" href="jquery-easyui-1.8.5/themes/icon.css">
    <script src="jquery-easyui-1.8.5/jquery.min.js"></script>
    <script src="jquery-easyui-1.8.5/jquery.easyui.min.js"></script>

</head>

<body style="padding: 20px">
    <div style="margin:20px 0;"></div>
    <div id="editcolumn">
        <div style="margin:20px 0;">
            <a href="javascript:void(0)" class="easyui-linkbutton" onclick="edit()">Edit</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" onclick="save()">Save</a>
            <a href="javascript:void(0)" class="easyui-linkbutton" onclick="cancel()">Cancel</a>
        </div>
        <table id="tg" class="easyui-treegrid" title="Editable TreeGrid" style="width:800px;height:auto" data-options="
                        iconCls: 'icon-ok',
                        rownumbers: true,
                        animate: true,
                        collapsible: true,
                        fitColumns: true,
                        data:columndata,
                        idField: 'id',
                        treeField: 'name',
                        onBeforeCollapse: function () {return false},
                    ">
            <thead>
                <tr>
                    <th data-options="field:'name',editor:'text'" width="220">表头名</th>
                    <th data-options="field:'type',formatter:formatType,editor:'text'" width="100">特性</th>
                    <th data-options="field:'des',editor:'text'" width="348">描述</th>
                    <th data-options="field:'editor',editor:editorCombo" width="100">编辑类型</th>
                </tr>
            </thead>
        </table>
        <div style="margin:20px 0;"></div>
    </div>

    <div style="margin:20px 0;"></div>
    <table id="table" title="DataGrid with Toolbar" style="width:800px;height:auto">
    </table>
    <script src="index.js"></script>

    <script type="text/javascript">
        function formatProgress(value) {
            if (value) {
                var s = '<div style="width:100%;border:1px solid #ccc">' +
                    '<div style="width:' + value + '%;background:#cc0000;color:#fff">' + value + '%' + '</div>'
                '</div>';
                return s;
            } else {
                return '';
            }
        }

        var editingId;

        function edit() {
            if (editingId != undefined) {
                $('#tg').treegrid('select', editingId);
                return;
            }
            var row = $('#tg').treegrid('getSelected');
            if (row) {
                editingId = row.id
                $('#tg').treegrid('beginEdit', editingId);
            }
        }

        function save() {
            if (editingId != undefined) {
                var t = $('#tg');
                t.treegrid('endEdit', editingId);
                editingId = undefined;
                localStorage.setItem("columns", JSON.stringify(columndata));
                
                // var persons = 0;
                // var rows = t.treegrid('getChildren');
                // for (var i = 0; i < rows.length; i++) {
                //     var p = parseInt(rows[i].persons);
                //     if (!isNaN(p)) {
                //         persons += p;
                //     }
                // }
                // var frow = t.treegrid('getFooterRows')[0];
                // frow.persons = persons;
                // t.treegrid('reloadFooter');
            }
        }

        function cancel() {
            if (editingId != undefined) {
                $('#tg').treegrid('cancelEdit', editingId);
                editingId = undefined;
            }
        }

        function formatType(value, row, index) {
            if (value === "merge") {
                value = '合并列';
            } else {
                value = '数据列';
            }
            return value;
        }
        var editorCombo = {
            type: 'combobox',
            options: {
                valueField: 'label',
                textField: 'value',
                data: [{
                    label: '不可编辑',
                    value: ''
                }, {
                    label: 'text',
                    value: 'text'
                }, {
                    label: 'textarea',
                    value: 'textarea'
                }, {
                    label: 'datebox',
                    value: 'datebox'
                }, {
                    label: 'numberbox',
                    value: 'numberbox'
                }]
            }
        }
        // var editingId;
        var toolbar2 = [{
            text: '新增',
            iconCls: 'icon-add',
            handler: function () {
                alert('add')
            }
        }, {
            text: '删除',
            iconCls: 'icon-remove',
            handler: function () {
                alert('cut')
            }
        }, '-', {
            text: '编辑',
            iconCls: 'icon-edit',
            handler: function () {
                if (editingId != undefined) {
                    $('#editcolumn').treegrid('select', editingId);
                    return;
                }
                var row = $('#editcolumn').treegrid('getSelected');
                // var row = $('#editcolumn').treegrid('getSelected');
                if (row) {
                    editingId = row.id
                    $('#editcolumn').treegrid('beginEdit', editingId);
                }
            }
        }, '-', {
            text: '保存',
            iconCls: 'icon-save',
            handler: function () {
                // $('#editcolumn').toggle();
            }
        }, '-', {
            text: '取消',
            iconCls: 'icon-cancel',
            handler: function () {
                // $('#editcolumn').toggle();
            }
        }];
        // $(function () {
        var columndata;
        if (localStorage.getItem('columns')) {
            columndata = JSON.parse(localStorage.getItem('columns'));
            // $('#mycolumn').treegrid({
            //     data: data,
            //     toolbar: toolbar2
            // })
        } else {
            $.get('json/head.json', function (data2) {
                // 生成表头，然后初始化表格
                addIcon(data2);
                localStorage.setItem("columns", JSON.stringify(data2));
                columndata = data2;
                // $('#mycolumn').treegrid({
                //     data: columndata,
                //     toolbar: toolbar2
                // })

            })
        }
        // })
        // 定义界面初始化和column编辑界面
        // 1. 增加列
        // 2. 增加子列
        // 3. 编辑列名
        // 4. 删除列 （用户删除列之后就数据库删除该行数据）
        // 5. 排序
        // 列移动
        // 
        var ColumnConfig = (function () {
            //私有方法，外面将访问不到
            var _createRow = function (that) {
                // 两种创建 1、自定义  2、用UI 控件
                var $row = $('')
                that.append();
            }


            //视图和页面紧密联系
            /*
             *config{slector，columns} 
             */
            var ColumnConfig = function (config) {}

            // 1、渲染
            ColumnConfig.prototype.init = function (config) {
                this.contaner = $(slector);
                // 生成dom视图
                // 表格的操作比较灵活;

                return this;
            };

            // 2、新加：（新加单列， 新加合并列（允许空，允许只有一个，是非数据列）），在合并列中新增；

            // 3、操作： (编辑信息，编辑是加入入到哪一个合并列)，排序;

            // 4、排序： (新增自动生成排序号，移动到新的数据后就生成新的序号)， 上移与下移；后台排好序

            // 5、删除： 删除合并列、 删除单列；

        })()


        var TextCount = (function () {
            //私有方法，外面将访问不到
            var _bind = function (that) {
                that.input.on('keyup', function () {
                    that.render();
                });
            }
            // 获取数据
            var _getNum = function (that) {
                return that.input.val().length;
            }

            // 对象构建函数
            var TextCountFun = function (config) {

            }

            // 通过原型链来继承
            TextCountFun.prototype.init = function (config) {
                this.input = $(config.id);
                console.log(config);
                _bind(this);
                return this;
            };

            // 通过原型链来继承
            TextCountFun.prototype.render = function () {
                var num = _getNum(this);

                if ($('#J_input_count').length !== 2) {
                    this.input.after('<span id="J_input_count"></span>');
                };

                $('#J_input_count').html(num + '个字');
            };

            //返回构造函数
            return TextCountFun;

        })();
    </script>
</body>

</html>